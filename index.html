<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Maid Pro | ศูนย์รวมแม่บ้านมืออาชีพ</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    tailwind.config = {
        theme: {
            extend: {
                colors: {
                    corporate: '#0f172a', // Slate 900 - Main Dark
                    corporateLight: '#1e293b', // Slate 800
                    action: '#0369a1', // Sky 700 - Action Blue
                    actionHover: '#0284c7', // Sky 600
                    bgPage: '#f8fafc', // Slate 50
                    textMain: '#334155', // Slate 700
                    borderLine: '#cbd5e1', // Slate 300
                },
                fontFamily: {
                    sans: ['Prompt', 'sans-serif'],
                },
                boxShadow: {
                    'pro': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                    'pro-hover': '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)',
                }
            }
        }
    }
</script>

<style>
    body { 
        font-family: 'Prompt', sans-serif; 
        background-color: #f8fafc;
        color: #334155; 
        -webkit-tap-highlight-color: transparent; 
        overflow-x: hidden;
        min-height: 100vh;
    }

    body.no-scroll { overflow: hidden; }
    
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
    
    dialog {
        transition: all 0.2s ease-out;
        opacity: 0;
        transform: scale(0.98) translateY(10px);
        border: none;
        outline: none;
        background-color: #ffffff;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        border-radius: 0.5rem; /* rounded-lg */
    }
    dialog[open] { opacity: 1; transform: scale(1) translateY(0); }
    dialog::backdrop { background: rgba(15, 23, 42, 0.5); backdrop-filter: blur(2px); }
    
    .glass-nav { 
        background: rgba(255, 255, 255, 0.95); 
        backdrop-filter: blur(8px); 
        border-bottom: 1px solid #e2e8f0;
        box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
    }

    input, select, textarea {
        background-color: #ffffff !important;
        border: 1px solid #cbd5e1 !important;
        transition: all 0.2s ease;
        border-radius: 0.375rem !important; /* rounded-md */
        color: #1e293b !important;
    }
    input:focus, select:focus, textarea:focus {
        border-color: #0369a1 !important;
        box-shadow: 0 0 0 3px rgba(3, 105, 161, 0.1);
        outline: none;
    }

    .maid-card {
        background: white;
        border-radius: 0.5rem;
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
    }
    .maid-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        border-color: #94a3b8;
    }

    .btn-corporate {
        background-color: #0f172a;
        color: white;
        transition: all 0.2s ease;
        border-radius: 0.375rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.025em;
    }
    .btn-corporate:hover {
        background-color: #1e293b;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }
    .btn-corporate:active { transform: translateY(0); }

    .search-container {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
        border: 1px solid #e2e8f0;
    }

    /* Slider Animation */
    .slider-hidden { opacity: 0; pointer-events: none; }
    .slider-visible { opacity: 1; pointer-events: auto; }
</style>
</head>
<body class="flex flex-col">

<!-- Navigation -->
<nav class="glass-nav sticky top-0 z-50 h-16">
  <div class="max-w-7xl mx-auto px-6 h-full flex justify-between items-center">
      <div class="flex items-center gap-3 cursor-pointer group" onclick="refreshApp()">
        <div class="bg-corporate text-white w-9 h-9 flex items-center justify-center rounded shadow-sm">
            <i class="fa-solid fa-shield-halved text-sm"></i>
        </div>
        <div class="flex flex-col">
            <span class="font-bold text-lg text-corporate tracking-tight leading-none uppercase">Maid<span class="text-action">Pro</span></span>
            <span class="text-[9px] text-slate-500 font-bold tracking-widest uppercase">Professional Service</span>
        </div>
      </div>
      
      <div class="flex items-center gap-3">
          <div class="hidden sm:flex flex-col items-end mr-2">
              <span class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Trusted by</span>
              <span class="text-xs font-bold text-slate-700">10,000+ Users</span>
          </div>
          <div class="w-8 h-8 rounded bg-slate-100 text-slate-600 flex items-center justify-center border border-slate-200">
              <i class="fa-solid fa-user-tie text-xs"></i>
          </div>
      </div>
  </div>
</nav>

<main class="flex-grow max-w-6xl mx-auto px-4 sm:px-6 w-full pb-16">
    
    <!-- Search Section (Clean Layout) -->
    <div class="py-8 sm:py-10 flex flex-col items-center">
        <!-- Search Container -->
        <div class="search-container w-full max-w-4xl p-5 bg-white relative z-10">
            <!-- Row 1: Inputs -->
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <div class="relative flex-1">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1 tracking-wider">พื้นที่ให้บริการ</label>
                    <div class="relative">
                        <select id="filter_province" class="w-full pl-9 pr-4 py-2.5 appearance-none cursor-pointer bg-slate-50 text-sm font-medium text-slate-700 border border-slate-300 focus:border-action">
                            <option value="all">แสดงทั้งหมด</option>
                        </select>
                        <i class="fa-solid fa-location-dot absolute left-3 top-3 text-slate-400 text-xs"></i>
                        <i class="fa-solid fa-caret-down absolute right-3 top-3 text-slate-400 text-xs pointer-events-none"></i>
                    </div>
                </div>
                <div class="relative flex-[2]">
                    <label class="block text-[10px] font-bold text-slate-400 uppercase mb-1 ml-1 tracking-wider">ค้นหาบริการ</label>
                    <div class="relative">
                        <input id="q_input" type="text" placeholder="ระบุประเภทงาน (เช่น รีดผ้า, ทำความสะอาดใหญ่)" class="w-full pl-9 pr-4 py-2.5 bg-slate-50 text-sm text-slate-700 border border-slate-300 focus:border-action placeholder:text-slate-400">
                        <i class="fa-solid fa-magnifying-glass absolute left-3 top-3 text-slate-400 text-xs"></i>
                    </div>
                </div>
            </div>
            
            <!-- Row 2: Register Button -->
            <div class="pt-4 border-t border-slate-100">
                <button onclick="openNewPostModal()" class="btn-corporate w-full py-3 flex items-center justify-center gap-2 text-sm shadow-sm hover:shadow-md transition-all">
                    <i class="fa-solid fa-clipboard-check text-actionHover"></i> 
                    ลงทะเบียนผู้ให้บริการใหม่
                </button>
            </div>
        </div>
    </div>
    
    <div id="loading" class="flex flex-col items-center justify-center py-16 border-t border-slate-200 mt-4">
        <div class="w-8 h-8 border-2 border-slate-200 border-t-corporate rounded-full animate-spin mb-3"></div>
        <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Loading Database...</p>
    </div>
    
    <!-- Grid System (2 Cols Mobile) -->
    <section id="board" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-5 mb-12"></section>

    <!-- Pagination -->
    <div id="pagination" class="flex justify-center items-center gap-2 pt-8 border-t border-slate-200">
        <button onclick="changePage(-1)" id="btnPrev" class="px-3 py-1.5 border border-slate-300 rounded text-slate-600 hover:bg-slate-50 disabled:opacity-50 text-xs font-medium transition-colors">
            <i class="fa-solid fa-chevron-left mr-1"></i> Prev
        </button>
        <div class="px-4 py-1.5 bg-slate-100 rounded text-xs font-bold text-slate-700 border border-slate-200">
            Page <span id="pageIndicator" class="mx-1">1</span>
        </div>
        <button onclick="changePage(1)" id="btnNext" class="px-3 py-1.5 border border-slate-300 rounded text-slate-600 hover:bg-slate-50 disabled:opacity-50 text-xs font-medium transition-colors">
            Next <i class="fa-solid fa-chevron-right ml-1"></i>
        </button>
    </div>
</main>

<!-- Footer -->
<footer class="mt-auto py-8 bg-corporate text-center text-slate-400 text-xs border-t border-slate-800">
    <div class="max-w-4xl mx-auto px-4 flex flex-col md:flex-row justify-between items-center gap-4">
        <div class="text-left">
            <h4 class="text-white font-bold uppercase tracking-widest mb-1 text-[10px]">Maid Pro Service</h4>
            <p class="text-[10px] text-slate-500">Professional Cleaning Solution Platform</p>
        </div>
        <div class="flex gap-4 text-slate-500">
            <a href="#" class="hover:text-white transition-colors">Terms</a>
            <a href="#" class="hover:text-white transition-colors">Privacy</a>
            <a href="#" class="hover:text-white transition-colors">Support</a>
        </div>
        <div class="text-[10px] text-slate-600">
            © 2024 Maid Pro Inc. All rights reserved.
        </div>
    </div>
</footer>

<!-- View Detail Dialog -->
<dialog id="viewDlg" class="w-[95%] max-w-3xl m-auto p-0 overflow-hidden shadow-2xl">
    <div class="flex flex-col md:flex-row h-full max-h-[85vh]">
        <!-- Image Section -->
        <div class="w-full md:w-5/12 bg-slate-100 relative h-64 md:h-auto border-r border-slate-200">
             <div id="detailImageHero" class="w-full h-full cursor-pointer overflow-hidden group">
                <img id="viewHeroImg" src="" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" onerror="handleImgError(this)">
            </div>
            <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-2 px-4" id="viewImages"></div>
            
            <!-- Mobile Actions (Delete & Close) -->
            <div class="absolute top-3 right-3 md:hidden flex gap-2 z-10">
                 <button id="btnDeletePostMobile" class="w-8 h-8 bg-black/60 text-white rounded flex items-center justify-center backdrop-blur-sm hover:bg-red-500 transition-colors">
                    <i class="fa-solid fa-trash-can text-xs"></i>
                </button>
                <button onclick="closeViewModal()" class="w-8 h-8 bg-black/60 text-white rounded flex items-center justify-center backdrop-blur-sm hover:bg-slate-700 transition-colors">
                    <i class="fa-solid fa-xmark"></i>
                </button>
            </div>
        </div>
        
        <!-- Content Section -->
        <div class="w-full md:w-7/12 bg-white flex flex-col p-6 sm:p-8 overflow-hidden">
            <div class="hidden md:flex justify-between items-start mb-6 border-b border-slate-100 pb-4">
                <div class="flex flex-col">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Profile Status</span>
                    <span class="text-xs font-bold text-green-600 flex items-center gap-1">
                        <i class="fa-solid fa-certificate"></i> Verified Professional
                    </span>
                </div>
                <div class="flex gap-2">
                     <button id="btnDeletePost" class="text-slate-400 hover:text-red-600 transition-colors w-8 h-8 flex items-center justify-center rounded hover:bg-slate-50 border border-transparent hover:border-slate-200">
                        <i class="fa-solid fa-trash-can text-xs"></i>
                    </button>
                    <button onclick="closeViewModal()" class="text-slate-400 hover:text-corporate transition-colors w-8 h-8 flex items-center justify-center rounded hover:bg-slate-50 border border-transparent hover:border-slate-200">
                        <i class="fa-solid fa-xmark text-lg"></i>
                    </button>
                </div>
            </div>

            <div class="overflow-y-auto pr-2 custom-scroll flex-grow">
                <h2 id="viewTitle" class="text-xl font-bold text-corporate mb-2 leading-tight"></h2>
                
                <div class="flex items-center gap-4 mb-6 text-sm pb-4 border-b border-slate-100">
                    <div class="flex items-center text-slate-600">
                        <i class="fa-solid fa-location-dot text-action mr-2"></i>
                        <span id="viewProvince"></span>
                    </div>
                    <div class="h-4 w-px bg-slate-200"></div>
                    <div class="flex items-center text-slate-600">
                        <i class="fa-solid fa-user-tie text-slate-400 mr-2"></i>
                        <span id="viewContact"></span>
                    </div>
                </div>

                <div class="bg-slate-50 rounded-lg p-4 border border-slate-200 mb-6 flex justify-between items-center">
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider mb-1">อัตราค่าบริการเริ่มต้น</p>
                        <div class="flex items-baseline gap-1">
                            <span id="viewPrice" class="text-2xl font-bold text-corporate"></span>
                            <span class="text-xs text-slate-500 font-medium">บาท / งาน</span>
                        </div>
                    </div>
                    <div class="w-10 h-10 bg-white rounded border border-slate-200 flex items-center justify-center text-slate-400">
                        <i class="fa-solid fa-tag"></i>
                    </div>
                </div>

                <div class="space-y-4 mb-4">
                    <div>
                        <h4 class="text-[11px] font-bold text-slate-900 uppercase tracking-wide mb-2">รายละเอียดและขอบเขตงาน</h4>
                        <p id="viewBody" class="text-slate-600 text-sm leading-relaxed whitespace-pre-line"></p>
                    </div>
                    <div>
                        <h4 class="text-[11px] font-bold text-slate-900 uppercase tracking-wide mb-1">พื้นที่ให้บริการเฉพาะเจาะจง</h4>
                        <p class="text-sm text-slate-600"><i class="fa-solid fa-map-pin text-slate-400 mr-1"></i> <span id="viewAddress"></span></p>
                    </div>
                </div>
            </div>

            <div class="pt-5 mt-auto border-t border-slate-100">
                <div class="flex justify-between items-center mb-3">
                    <span class="text-[10px] text-slate-400 font-mono uppercase">ID: <span id="viewPublishDate"></span></span>
                </div>
                <a id="btnCall" href="#" class="btn-corporate w-full py-3 rounded flex items-center justify-center gap-2 shadow-md hover:shadow-lg transition-all">
                    <i class="fa-solid fa-phone-volume"></i> ติดต่อจ้างงาน
                </a>
            </div>
        </div>
    </div>
</dialog>

<!-- Registration Dialog -->
<dialog id="dlg" class="rounded-lg w-[95%] max-w-lg m-auto p-0 bg-white shadow-2xl overflow-hidden">
    <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-corporate text-white rounded flex items-center justify-center shadow-sm"><i class="fa-solid fa-pen-nib text-xs"></i></div>
            <div>
                <h3 class="text-base font-bold text-corporate leading-none">ลงทะเบียนผู้ให้บริการ</h3>
                <span class="text-[10px] text-slate-500 font-medium uppercase tracking-wide">Registration Form</span>
            </div>
        </div>
        <button onclick="closeModal()" class="w-8 h-8 rounded hover:bg-slate-200 flex items-center justify-center text-slate-500 transition-colors"><i class="fa-solid fa-xmark"></i></button>
    </div>
    
    <div class="p-6 space-y-5 overflow-y-auto max-h-[65vh] custom-scroll bg-white">
        <div>
            <label class="block text-[11px] font-bold text-slate-700 uppercase mb-1.5 ml-0.5">หัวข้อบริการ <span class="text-red-500">*</span></label>
            <input id="title" type="text" class="w-full px-3 py-2.5 text-sm" placeholder="ระบุประเภทงานที่รับ เช่น ทำความสะอาดคอนโด">
        </div>
        
        <div class="grid grid-cols-2 gap-4">
             <div>
                <label class="block text-[11px] font-bold text-slate-700 uppercase mb-1.5 ml-0.5">จังหวัด <span class="text-red-500">*</span></label>
                <select id="input_province" class="w-full px-3 py-2.5 text-sm appearance-none cursor-pointer">
                    <option value="">เลือกจังหวัด</option>
                </select>
            </div>
            <div>
                <label class="block text-[11px] font-bold text-slate-700 uppercase mb-1.5 ml-0.5">ค่าบริการ (บาท) <span class="text-red-500">*</span></label>
                <input id="price" type="number" class="w-full px-3 py-2.5 text-sm" placeholder="0.00">
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-[11px] font-bold text-slate-700 uppercase mb-1.5 ml-0.5">ชื่อผู้ติดต่อ</label>
                <input id="contact_name" type="text" class="w-full px-3 py-2.5 text-sm" placeholder="ชื่อจริง / นามสกุล">
            </div>
            <div>
                <label class="block text-[11px] font-bold text-slate-700 uppercase mb-1.5 ml-0.5">เบอร์โทรศัพท์ <span class="text-red-500">*</span></label>
                <input id="phone" type="tel" class="w-full px-3 py-2.5 text-sm" placeholder="08x-xxxxxxx">
            </div>
        </div>

        <div>
            <label class="block text-[11px] font-bold text-slate-700 uppercase mb-1.5 ml-0.5">รายละเอียดประสบการณ์</label>
            <textarea id="body" rows="4" class="w-full px-3 py-2.5 text-sm resize-none" placeholder="ระบุประสบการณ์ อุปกรณ์ที่มี และเงื่อนไขการทำงาน..."></textarea>
            <input id="address" type="text" class="w-full px-3 py-2.5 text-sm mt-3" placeholder="ระบุเขต/อำเภอ ที่สะดวกเดินทาง">
        </div>
        
        <div class="bg-slate-50 p-4 rounded border border-slate-200">
            <div class="flex justify-between items-center mb-3">
                <label class="block text-[11px] font-bold text-slate-700 uppercase">รูปภาพประกอบ (Max 3)</label>
                <span id="imgCount" class="text-[10px] font-mono text-slate-500">0/3</span>
            </div>
            <div class="flex gap-3 overflow-x-auto pb-1">
                <div id="previewList" class="contents"></div>
                <label id="uploadBtn" class="flex-shrink-0 w-20 h-20 border border-dashed border-slate-300 rounded cursor-pointer bg-white hover:border-corporate hover:bg-slate-50 flex flex-col items-center justify-center text-slate-400 transition-all group">
                    <i class="fa-solid fa-plus text-lg mb-1 group-hover:text-corporate"></i>
                    <span class="text-[9px] font-bold uppercase">Upload</span>
                    <input id="img" type="file" class="hidden" accept="image/*" multiple onchange="appendImages(this)">
                </label>
            </div>
        </div>
    </div>
    
    <div class="p-4 border-t border-slate-200 flex gap-3 bg-slate-50">
        <button onclick="closeModal()" class="flex-1 px-4 py-2.5 bg-white border border-slate-300 text-slate-700 rounded text-sm font-bold uppercase tracking-wider hover:bg-slate-100 transition-colors">Cancel</button>
        <button onclick="savePost()" id="btnSave" class="btn-corporate flex-[2] py-2.5 rounded text-sm font-bold shadow-sm flex items-center justify-center gap-2">
            <span id="btnSaveText">Confirm Registration</span> 
        </button>
    </div>
</dialog>

<!-- Full Screen Slider -->
<div id="imageSlider" class="fixed inset-0 z-[100] bg-black/95 flex flex-col items-center justify-center slider-hidden transition-all duration-200" onclick="if(event.target === this) closeImageSlider()">
    <button onclick="closeImageSlider()" class="absolute top-6 right-6 text-slate-400 hover:text-white w-10 h-10 flex items-center justify-center transition-colors z-[120] bg-black/20 rounded-full backdrop-blur-sm">
        <i class="fa-solid fa-xmark text-2xl"></i>
    </button>
    <div class="relative w-full h-full flex items-center justify-center p-4">
        <button onclick="changeSlide(-1)" class="absolute left-4 text-slate-400 hover:text-white w-12 h-12 hidden sm:flex items-center justify-center transition-all z-[110]"><i class="fa-solid fa-chevron-left text-3xl"></i></button>
        <img id="sliderMainImage" src="" class="max-w-full max-h-[85vh] object-contain shadow-2xl border border-slate-800 pointer-events-none">
        <button onclick="changeSlide(1)" class="absolute right-4 text-slate-400 hover:text-white w-12 h-12 hidden sm:flex items-center justify-center transition-all z-[110]"><i class="fa-solid fa-chevron-right text-3xl"></i></button>
    </div>
    <div class="absolute bottom-8 flex flex-col items-center gap-4 z-[110]">
        <span id="sliderCounter" class="text-slate-400 text-xs font-mono tracking-widest">1 / 1</span>
    </div>
</div>

<script>
/* --- CONFIG & STATE --- */
const API_URL = "https://script.google.com/macros/s/AKfycbx7dacXQW2TsUcvDxeubbXujX-WCyFfFECpxTPyGoUZMRKRyWR9z1BeXR31JI0Rtmhf/exec"; 
const PROVINCES = ["กรุงเทพมหานคร", "กระบี่", "กาญจนบุรี", "กาฬสินธุ์", "กำแพงเพชร", "ขอนแก่น", "จันทบุรี", "ฉะเชิงเทรา", "ชลบุรี", "ชัยนาท", "ชัยภูมิ", "ชุมพร", "เชียงราย", "เชียงใหม่", "ตรัง", "ตราด", "ตาก", "นครนายก", "นครปฐม", "นครพนม", "นครราชสีมา", "นครศรีธรรมราช", "นครสวรรค์", "นนทบุรี", "นราธิวาส", "น่าน", "บึงกาฬ", "บุรีรัมย์", "ปทุมธานี", "ประจวบคีรีขันธ์", "ปราจีนบุรี", "ปัตตานี", "พระนครศรีอยุธยา", "พะเยา", "พังงา", "พัทลุง", "พิจิตร", "พิษณุโลก", "เพชรบุรี", "เพชรบูรณ์", "แพร่", "ภูเก็ต", "มหาสารคาม", "มุกดาหาร", "แม่ฮ่องสอน", "ยโสธร", "ยะลา", "ร้อยเอ็ด", "ระนอง", "ระยอง", "ราชบุรี", "ลพบุรี", "ลำปาง", "ลำพูน", "เลย", "ศรีสะเกษ", "สกลนคร", "สงขลา", "สตูล", "สมุทรปราการ", "สมุทรสงคราม", "สมุทรสาคร", "สระแก้ว", "สระบุรี", "สิงห์บุรี", "สุโขทัย", "สุพรรณบุรี", "สุราษฎร์ธานี", "สุรินทร์", "หนองคาย", "หนองบัวลำภู", "อ่างทอง", "อำนาจเจริญ", "อุดรธานี", "อุตรดิตถ์", "อุทัยธานี", "อุบลราชธานี"].sort();

let posts = [];
let filteredPosts = [];
let currentPage = 1;
const ITEMS_PER_PAGE = 12; 
let formImages = [];
let sliderImages = [];
let sliderIndex = 0;

const dom = {
    loading: document.getElementById('loading'),
    board: document.getElementById('board'),
    pageIndicator: document.getElementById('pageIndicator'),
    btnPrev: document.getElementById('btnPrev'),
    btnNext: document.getElementById('btnNext'),
    dlg: document.getElementById('dlg'),
    viewDlg: document.getElementById('viewDlg'),
    btnSaveText: document.getElementById('btnSaveText'),
    title: document.getElementById('title'),
    price: document.getElementById('price'),
    province: document.getElementById('input_province'),
    contactName: document.getElementById('contact_name'),
    phone: document.getElementById('phone'),
    address: document.getElementById('address'),
    body: document.getElementById('body'),
    imgPreview: document.getElementById('previewList'),
    imgCount: document.getElementById('imgCount'),
    uploadBtn: document.getElementById('uploadBtn'),
    filterProvince: document.getElementById('filter_province'),
    qInput: document.getElementById('q_input'),
    slider: document.getElementById('imageSlider'),
    sliderImg: document.getElementById('sliderMainImage'),
    sliderCount: document.getElementById('sliderCounter'),
    viewHero: document.getElementById('viewHeroImg'),
    viewDate: document.getElementById('viewPublishDate')
};

function handleImgError(img) { 
    img.src = 'https://placehold.co/600x400/e2e8f0/64748b?text=Professional+Service'; 
}
function setScrollLock(lock) { document.body.classList.toggle('no-scroll', lock); }

function init() {
    populateProvinces();
    loadPosts();
    dom.qInput.addEventListener('input', debounce(applyFilters, 400));
    dom.filterProvince.addEventListener('change', applyFilters);
}

function populateProvinces() {
    const html = PROVINCES.map(p => `<option value="${p}">${p}</option>`).join('');
    dom.province.innerHTML = `<option value="">เลือกจังหวัด</option>${html}`;
    dom.filterProvince.innerHTML = `<option value="all">แสดงทั้งหมด</option>${html}`;
}

async function loadPosts() {
    dom.loading.classList.remove('hidden');
    dom.board.innerHTML = '';
    try {
        const res = await fetch(`${API_URL}?t=${Date.now()}`);
        const data = await res.json();
        posts = (Array.isArray(data) ? data : data.data || []).map(p => {
            let imgs = [];
            try {
                const imgData = p.images;
                if (typeof imgData === 'string' && imgData.trim().startsWith('[')) imgs = JSON.parse(imgData);
                else if (imgData && imgData !== "null") imgs = [imgData];
            } catch(e) { imgs = p.images ? [p.images] : []; }
            
            imgs = imgs.map(url => {
                if (typeof url === 'string' && url.includes('id=')) {
                    const id = url.split('id=')[1].split('&')[0];
                    return `https://lh3.googleusercontent.com/d/${id}`;
                }
                return url;
            });
            return { ...p, images: imgs };
        }).reverse();
    } catch (e) { 
        posts = []; 
        Swal.fire({
            icon: 'error',
            title: 'System Error',
            text: 'Connection failed. Please try again later.',
            confirmButtonColor: '#0f172a'
        });
    } finally {
        dom.loading.classList.add('hidden');
        applyFilters();
    }
}

function applyFilters() {
    const q = dom.qInput.value.toLowerCase();
    const prov = dom.filterProvince.value;
    filteredPosts = posts.filter(p => {
        const matchText = (String(p.title)+String(p.body)+String(p.province)).toLowerCase().includes(q);
        const matchProv = prov === 'all' || p.province === prov;
        return matchText && matchProv;
    });
    currentPage = 1;
    renderBoard();
}

function renderBoard() {
    dom.board.innerHTML = '';
    const start = (currentPage - 1) * ITEMS_PER_PAGE;
    const items = filteredPosts.slice(start, start + ITEMS_PER_PAGE);
    
    if (items.length === 0) {
        dom.board.innerHTML = `
        <div class="col-span-full py-20 text-center flex flex-col items-center opacity-60">
            <div class="w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center mb-4 border border-slate-200">
                <i class="fa-solid fa-inbox text-xl text-slate-400"></i>
            </div>
            <p class="text-slate-500 font-medium text-sm">No professional records found.</p>
        </div>`;
    } else {
        items.forEach(p => {
            const thumb = (p.images && p.images.length > 0) ? p.images[0] : 'https://placehold.co/600x400/e2e8f0/64748b?text=Maid';
            const card = document.createElement('div');
            card.className = "maid-card group flex flex-col overflow-hidden cursor-pointer h-full relative bg-white";
            card.onclick = () => viewDetail(p.id);
            
            card.innerHTML = `
                <div class="relative aspect-[16/10] bg-slate-100 overflow-hidden border-b border-slate-100">
                    <img src="${thumb}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105" onerror="this.src='https://placehold.co/600x400/e2e8f0/64748b?text=Maid'">
                    <div class="absolute top-2 left-2">
                         <span class="bg-corporate/90 text-white px-2 py-1 rounded text-[10px] font-bold shadow-sm uppercase tracking-wide flex items-center gap-1 backdrop-blur-sm">
                            <i class="fa-solid fa-location-dot text-[8px]"></i> ${p.province}
                         </span>
                    </div>
                </div>
                <div class="p-3 sm:p-4 flex flex-col flex-grow relative">
                    <div class="mb-2 sm:mb-3">
                        <h3 class="font-bold text-slate-800 text-xs sm:text-sm line-clamp-1 group-hover:text-action transition-colors">${p.title}</h3>
                        <p class="text-[10px] text-slate-400 font-medium mt-1">Verified Professional</p>
                    </div>
                    
                    <div class="flex items-center gap-2 mb-3 sm:mb-4 pt-2 sm:pt-3 border-t border-slate-50">
                        <div class="w-5 h-5 sm:w-6 sm:h-6 rounded bg-slate-50 text-slate-400 flex items-center justify-center border border-slate-100">
                            <i class="fa-solid fa-user text-[10px]"></i>
                        </div>
                        <span class="text-[10px] sm:text-xs text-slate-600 font-medium truncate">${p.contact_name || 'Professional Maid'}</span>
                    </div>
                    
                    <div class="mt-auto flex items-end justify-between">
                        <div>
                             <p class="text-[9px] text-slate-400 font-bold uppercase tracking-wider">Starting at</p>
                             <div class="font-bold text-corporate text-base sm:text-lg leading-none">฿${Number(p.price).toLocaleString()}</div>
                        </div>
                        <button class="w-7 h-7 sm:w-8 sm:h-8 rounded bg-slate-50 text-slate-400 flex items-center justify-center group-hover:bg-corporate group-hover:text-white transition-all border border-slate-100 group-hover:border-corporate">
                            <i class="fa-solid fa-arrow-right text-[10px] sm:text-xs"></i>
                        </button>
                    </div>
                </div>
            `;
            dom.board.appendChild(card);
        });
    }
    updatePagination();
}

function updatePagination() {
    const total = Math.ceil(filteredPosts.length / ITEMS_PER_PAGE) || 1;
    dom.pageIndicator.textContent = `${currentPage} / ${total}`;
    dom.btnPrev.disabled = currentPage === 1;
    dom.btnNext.disabled = currentPage === total;
    dom.btnPrev.classList.toggle('opacity-50', currentPage === 1);
    dom.btnNext.classList.toggle('opacity-50', currentPage === total);
}

function changePage(delta) { 
    currentPage += delta; 
    renderBoard(); 
    window.scrollTo({ top: 0, behavior: 'smooth' }); 
}

function openNewPostModal() { resetForm(); dom.dlg.showModal(); setScrollLock(true); }
function closeModal() { dom.dlg.close(); setScrollLock(false); }

function viewDetail(id) {
    const p = posts.find(x => x.id === id);
    if (!p) return;
    
    dom.viewHero.src = (p.images && p.images.length > 0) ? p.images[0] : 'https://placehold.co/600x400/e2e8f0/64748b?text=Maid';
    document.getElementById('viewTitle').textContent = p.title;
    document.getElementById('viewPrice').textContent = Number(p.price).toLocaleString();
    document.getElementById('viewContact').textContent = p.contact_name || 'Professional Maid';
    document.getElementById('viewProvince').textContent = p.province;
    document.getElementById('viewAddress').textContent = p.address || '-';
    document.getElementById('viewBody').textContent = p.body || 'No description provided.';
    dom.viewDate.textContent = new Date(p.id).toLocaleDateString('en-GB');
    document.getElementById('btnCall').href = p.phone ? `tel:${p.phone}` : "#";
    
    const imgBox = document.getElementById('viewImages');
    imgBox.innerHTML = '';
    sliderImages = p.images || [];
    
    if (sliderImages.length > 0) {
        sliderImages.forEach((url, i) => {
            const wrap = document.createElement('div');
            wrap.className = `w-12 h-12 rounded overflow-hidden border cursor-pointer transition-all ${i===0 ? 'border-corporate ring-1 ring-corporate shadow-sm' : 'border-slate-200 opacity-60 hover:opacity-100'}`;
            wrap.innerHTML = `<img src="${url}" class="w-full h-full object-cover">`;
            wrap.onclick = (e) => { e.stopPropagation(); openSlider(i); };
            imgBox.appendChild(wrap);
        });
    }

    // Bind Delete Events (Desktop & Mobile)
    const deleteAction = (e) => { e.stopPropagation(); confirmDelete(p.id); };
    if(document.getElementById('btnDeletePost')) document.getElementById('btnDeletePost').onclick = deleteAction;
    if(document.getElementById('btnDeletePostMobile')) document.getElementById('btnDeletePostMobile').onclick = deleteAction;

    dom.viewDlg.showModal();
    setScrollLock(true);
}

function closeViewModal() { dom.viewDlg.close(); setScrollLock(false); }

async function confirmDelete(id) {
    const res = await Swal.fire({
        title: 'Confirm Deletion?',
        text: 'This record will be permanently deleted.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#0f172a',
        cancelButtonColor: '#94a3b8',
        confirmButtonText: 'Delete',
        cancelButtonText: 'Cancel'
    });
    
    if (res.isConfirmed) {
        Swal.fire({ 
            title: 'Processing...', 
            didOpen: () => Swal.showLoading(), 
            showConfirmButton: false,
            allowOutsideClick: false
        });
        
        try {
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ action: 'delete', id: id }) });
            closeViewModal();
            setTimeout(() => { 
                loadPosts(); 
                Swal.fire({ icon: 'success', title: 'Deleted', confirmButtonColor: '#0f172a', timer: 1500 }); 
            }, 1000);
        } catch (e) { Swal.fire('Error', 'Operation failed', 'error'); }
    }
}

function appendImages(input) {
    const files = Array.from(input.files);
    if (formImages.length + files.length > 3) {
        Swal.fire({ text: 'Maximum 3 images allowed', icon: 'info', confirmButtonColor: '#0f172a' });
        return;
    }

    files.forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => { formImages.push(e.target.result); renderPreview(); };
        reader.readAsDataURL(file);
    });
}

function renderPreview() {
    dom.imgPreview.innerHTML = '';
    formImages.forEach((src, i) => {
        const div = document.createElement('div');
        div.className = "relative w-20 h-20 rounded border border-slate-200 overflow-hidden flex-shrink-0 group";
        div.innerHTML = `
            <img src="${src}" class="w-full h-full object-cover">
            <button onclick="removeImg(${i})" class="absolute top-1 right-1 bg-black/60 text-white w-5 h-5 rounded flex items-center justify-center text-[10px] hover:bg-red-600 transition-colors"><i class="fa-solid fa-trash"></i></button>
        `;
        dom.imgPreview.appendChild(div);
    });
    dom.imgCount.textContent = `${formImages.length}/3`;
    dom.uploadBtn.classList.toggle('hidden', formImages.length >= 3);
}

function removeImg(i) { formImages.splice(i, 1); renderPreview(); }

async function savePost() {
    const validations = [dom.title, dom.price, dom.province, dom.phone];
    let ok = true;
    validations.forEach(el => {
        if (!el.value.trim()) { 
            el.style.borderColor = '#ef4444'; 
            ok = false; 
        } else { 
            el.style.borderColor = '#cbd5e1'; 
        }
    });
    
    if (!ok) {
        Swal.fire({ toast: true, position: 'top', icon: 'warning', title: 'Please fill in all required fields.', showConfirmButton: false, timer: 3000 });
        return;
    }

    const btn = document.getElementById('btnSave');
    btn.disabled = true;
    const oldText = dom.btnSaveText.innerHTML;
    dom.btnSaveText.textContent = "Processing...";
    
    const payload = {
        action: 'add', id: Date.now(), title: dom.title.value, price: Number(dom.price.value),
        province: dom.province.value, address: dom.address.value, contact_name: dom.contactName.value,
        phone: dom.phone.value, body: dom.body.value, images: formImages
    };
    
    try {
        await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
        closeModal();
        Swal.fire({ 
            title: 'Registration Successful', 
            text: 'Your service has been listed.', 
            icon: 'success', 
            confirmButtonColor: '#0f172a'
        });
        setTimeout(() => loadPosts(), 1500);
    } catch (e) { 
        Swal.fire('Error', 'Submission failed.', 'error'); 
    } finally { 
        btn.disabled = false; 
        dom.btnSaveText.innerHTML = oldText; 
    }
}

function openSlider(i) {
    sliderIndex = i;
    dom.sliderImg.src = sliderImages[i];
    dom.sliderCount.textContent = `${i + 1} / ${sliderImages.length}`;
    if (dom.viewDlg.open) dom.viewDlg.close();
    dom.slider.classList.replace('slider-hidden', 'slider-visible');
    setScrollLock(true);
}

function closeImageSlider() { 
    dom.slider.classList.replace('slider-visible', 'slider-hidden'); 
    if (!dom.viewDlg.open && document.getElementById('viewTitle').textContent) dom.viewDlg.showModal(); 
    else setScrollLock(false);
}

function changeSlide(n) {
    sliderIndex = (sliderIndex + n + sliderImages.length) % sliderImages.length;
    dom.sliderImg.src = sliderImages[sliderIndex];
    dom.sliderCount.textContent = `${sliderIndex + 1} / ${sliderImages.length}`;
}

function debounce(fn, t) {
    let timer;
    return (...args) => { clearTimeout(timer); timer = setTimeout(() => fn(...args), t); };
}

function resetForm() {
    dom.title.value = dom.price.value = dom.province.value = dom.contactName.value = dom.phone.value = dom.address.value = dom.body.value = '';
    formImages = []; renderPreview();
    [dom.title, dom.price, dom.province, dom.phone].forEach(el => el.style.borderColor = '');
}

function refreshApp() {
    dom.qInput.value = '';
    dom.filterProvince.value = 'all';
    window.scrollTo({ top: 0, behavior: 'smooth' });
    loadPosts();
}

init();
</script>
</body>
</html>
